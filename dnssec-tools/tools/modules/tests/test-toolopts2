#!/usr/bin/perl
#
# Copyright 2004 Sparta, inc.  All rights reserved.  See the COPYING
# file distributed with this software for details
#
#
# dnssec-tools
#
# Test script for the dnssec-tools tooloptions module.  This script tests
# the opts_krfile() and opts_getkeys() interfaces.  Upon being given a
# keyrec file and the name of a zone's keyrec, the keyrecs of the zone's
# KSK and ZSK are printed.
#
# Executing with the following commands line should yield success:
#
#	test-toolopts2 -krf portrigh.keyrec -keyrec portrigh.com
#	test-toolopts2 -krf portrigh.keyrec -keyrec triharpskel.com
#
# Executing with any other -keyrec option should fail.
#
# Some of the data in the test keyrec file is nonsense.  However, it is
# useful to distinguish between keyrecs, thus allowing one to determine
# if the test passed or failed.
#

use strict;

use DNSSEC::tooloptions;

my $ropts;			# Reference to option table.
my %opts;			# Option hash table.

my $krf;			# Keyrec file.
my $dum;			# Dummy return value.

my $rkh;			# Reference to the KSK keyrec.
my $rzh;			# Reference to the ZSK keyrec.
my %kskrec;			# The KSK keyrec itself.
my %zskrec;			# The ZSK keyrec itself.


########################################################
#
# Build a keyrec file for use by these tests.
#
$krf = "portrigh.keyrec";
buildkrf($krf);

########################################################
#
# Get the options keyrec names of the KSK and ZSK for the
# zone specified in our command line.
#
($dum,$dum,$ropts) = opts_krfile("","");
if($ropts == undef)
{
	print "opts_krfile() returned an undefined option reference\n";
}
else
{
	%opts = %$ropts;

	print "kskkey\t\t$opts{'kskkey'}\n";
	print "zskkey\t\t$opts{'zskkey'}\n";
	print "\n";
}

########################################################
#
# Get the KSK and ZSK keyrecs for the zone specified in our command line.
#
($rkh,$rzh) = opts_getkeys();
if($rkh == undef)
{
	print "opts_getkeys() returned an undefined KSK option reference\n";
	exit(1);
}
if($rzh == undef)
{
	print "opts_getkeys() returned an undefined ZSK option reference\n";
	exit(1);
}

%kskrec = %$rkh;
%zskrec = %$rzh;

print "kskrec:\n";
foreach my $k (sort(keys(%kskrec)))
{
	print "\t$k\t\t$kskrec{$k}\n";
}
print "\n\n";

print "zskrec:\n";
foreach my $k (sort(keys(%zskrec)))
{
	print "\t$k\t\t$zskrec{$k}\n";
}
print "\n\n";



exit(0);

#####################################################################
#
# buildkrf()
#
sub buildkrf
{
	my $krf = shift;

        open(KRF,"> $krf");
	print KRF <<EOF;

#
# key management database
#

zone "portrigh.com"
	zonefile	"db.portrigh.com"
	kskpath		"keys.ksk/Kportrigh.com.+005+26000"
	zskpath		"keys.zsk/Kportrigh.com.+005+52000"
	endtime		"+8888888"		# good for 102 days
	kskkey		"Kportrigh.com.+005+26000"
	zskkey		"Kportrigh.com.+005+52000"

key "Kportrigh.com.+005+26000"
	zonename	"portrigh.com"
	type		"ksk"
	algorithm	"rsasha2"
	ksklength	"1024"
	random		"-r /dev/urandom1"

key "Kportrigh.com.+005+52000"
	zonename	"portrigh.com"
	type		"zsk"
	algorithm	"rsasha3"
	zsklength	"768"
	random		"-r /dev/urandom2"

zone "triharpskel.com"
	zonefile	"db.triharpskel.com"
	kskpath		"keys.ksk/Ktriharpskel.com.+005+26000"
	zskpath		"keys.zsk/Ktriharpskel.com.+005+52000"
	endtime		"+7800000"		# good for 90 days
	kskkey		"Ktriharpskel.com.+005+32000"
	zskkey		"Ktriharpskel.com.+005+64000"

key "Ktriharpskel.com.+005+32000"
	zonename	"triharpskel.com"
	type		"ksk"
	algorithm	"rsasha4"
	ksklength	"2048"
	random		"-r /dev/urandom3"

key "Ktriharpskel.com.+005+64000"
	zonename	"triharpskel.com"
	type		"zsk"
	algorithm	"rsasha5"
	zsklength	"2008"
	random		"-r /dev/urandom4"

EOF

	close(KRF);
}
