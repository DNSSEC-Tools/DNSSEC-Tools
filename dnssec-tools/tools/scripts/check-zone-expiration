#!/usr/bin/perl

use Net::DNS;
use Date::Parse;
use Net::DNS::SEC::Tools::timetrans;
use Net::DNS::SEC::Tools::QWPrimitives;

my %opts;
DTGetOptions(\%opts,
	     ['GUI:VERSION',           "DNSSEC-Tools Version: 1.13"],
	     ['GUI:otherargs_text',    "ZONENAME [ZONENAME...]"],
	     
	     ['m|minimum-reporting=s',
	                  "Minimum reporting time, or else remain silent"],
    );

if ($#ARGV == -1) {
    print STDERR "You must specify at least one ZONENAME for this tool to do anything useful\n";
    exit 1;
}

my $res    = Net::DNS::Resolver->new;

foreach my $zone (@ARGV) {
    my $query  = $res->query($zone, "RRSIG");
    if ($query) {
	my $rrsig = ($query->answer)[0];
	my $enddate = $rrsig->sigexpiration();
	$enddate =~ s/^(....)(..)(..)(..)(..)(..)/$1-$2-$3 $4:$5:$6/;
	my $epochtime = str2time($enddate);
	my $delta = $epochtime - time();
	print "$zone will expire in " . timetrans($delta) . "\n";
    } else {
	print "Failed to query for RRSIGs for '$zone'\n";
	print "This can happen because the authoritative server for the zone\n";
	print "or the local resolver doesn't support querying for RRSIGs\n";
    }
}

1;


