#!/usr/bin/perl
#
# Copyright 2008-2009 SPARTA, Inc.  All rights reserved.  See the COPYING
# file distributed with this software for details.
#
#
# getds
#

use Net::DNS;
use Net::DNS::SEC;
use Data::Dumper;
use Net::DNS::SEC::Tools::QWPrimitives;

my %opts =
  ( 'a' => 'SHA256'
  );

DTGetOptions(\%opts,
		['GUI:VERSION',"0.1\nDNSSEC-Tools Version: 1.4"],

		['a|hash-algorithm=s',
		 'Hash algorithm to use (SHA256 or SHA1)'],
		['z|print-zsks',     'Print ZSK DS records as well as KSKs'],

		['GUI:otherargs_text',"DOMAIN_NAME"],
	       ) || exit;

# query the DNSKEY from the net
my $res  = Net::DNS::Resolver->new;
my $q = $res->query($ARGV[0], "DNSKEY");
my @keys = $q->answer;

#
# for each of the keys found, print out the DS record
#
foreach my $key (@keys) {
    next if (($key->flags & 0x1) == 0);  # KSKs only
    $key->{'name'} = $ARGV[0];

    my $ds = create Net::DNS::RR::DS($key,
				     digtype => $opts{'a'},
				    );
    $ds->print;
}

=head1 NAME

getds - Create a DS record from DNSKEYing information

=head1 SYNOPSIS

getds <domain>

=head1 DESCRIPTION

B<getds> will create a DS record from DNSKEYs for the specified DNS
domain.  It does this by converting DNSKEYs to DS records using the
specified hashing algorithm.  The results can then be passed to
upstream DNSSEC-supporting parents or to DLV registries.

=head1 OPTIONS

B<getds> takes the following options:

=over 4

=item B<-hash-algorithm algorithm>  (-a)

This option specifies the hash algorithm to use when converting DNSKEYs to DS
records.  This may be either SHA256 (the default) or SHA1.
B<-a> is an alias for this option.

=item B<-print-zsks>  (-z)
    
This option causes B<getds> to print ZSK DS records, as well as KSK records.
B<-z> is an alias for this option.

=back

=head1 SECURITY CONSIDERATIONS

By default, getds pulls data from the live DNS.  If your DNS resolver
isn't configured so that this is pulled securely, then the results
can't be trusted.

=head1 COPYRIGHT

Copyright 2008-2009 SPARTA, Inc.  All rights reserved.
See the COPYING file included with the DNSSEC-Tools package for details.

=head1 AUTHOR

Wes Hardaker, hardaker AT AT AT users.sourceforge.net

=cut

