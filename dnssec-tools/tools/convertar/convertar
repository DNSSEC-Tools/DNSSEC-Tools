#!/usr/bin/perl

use Net::DNS::SEC::Tools::conf;
use Net::DNS::SEC::Tools::TrustAnchor;
use Net::DNS::SEC::Tools::QWPrimitives;
use strict;

my %opts;

#
# Perform some housekeeping if we're running packed.
#	- use the packed DNSSEC-Tools config file
#	- make sure the packed ParserDetails.ini file is where XML::SAX expects
#
if (runpacked()) {

    #
    # Use the packed config file.
    #
    setconffile("$ENV{'PAR_TEMP'}/inc/dnssec-tools.conf");

    #
    # Move the ParserDetails.ini file to its required location.
    #
    if (! -e "$ENV{'PAR_TEMP'}/SAX") {
	use Cwd;

	my $cwd = getcwd;

	chdir($ENV{'PAR_TEMP'});

	if (-e "inc/SAX") {
	    rename("inc/SAX", "SAX");
	}

	chdir($cwd);
    }
}


DTGetOptions(\%opts,
	     ["i|input-file=s",  "Input file(s)"],
	     ["o|output-file=s", "Output file(s)"],
	    ) || exit 1;

my $input_file = $opts{'i'} || shift @ARGV;
my $output_file = $opts{'o'} || shift @ARGV;

my ($mod, $file, $options) = parse_component($input_file);

my $tar = $mod->read();
die "reading tar from $input_file failed\n" if (!$tar);

if ($output_file ne '') {
    my ($mod, $file, $options) = parse_component($output_file);
    return if (!$mod);
    $mod->write($tar, $file);
}

=pod

=head1 NAME

B<convertar> - Converts trust anchor repositories from one format to another

=head1 DESCRIPTION

B<convertar> operates on input and output files of different Trust
Anchor Repository (TAR) formats.  B<convertar> decides what type of
file format is being referred to by a "type:filename" specification.
See below for a list of different input and output formats that
B<convertar> understands by default.

See the I<Net::DNS::SEC::Tools::TrustAnchor> module and its
documentation for writing new plugins to allow B<convertar> to understand
other TAR formats.

=head1 EXAMPLES

This command will read in an B<itar.xml> file (available from
https://itar.iana.org/) and convert it to a file that can be read in
by BIND's B<named> application:

  # convertar -i itar:itar.xml -o bind:bind.conf

=head1 FILE FORMATS

The following file formats are known by default to B<convertar>:

=over

=item bind

A BIND name server (B<named>) compatible trust anchor configuration file.
This can be included within a master B<named.conf> file using the
"include" directive.

=item csv

A comma-separated list format.

=item dump

A Perl hash I<dump> format.  This should be used mostly for debugging of
newly developed modules as it shows the internal hash structure that is
passed between modules.

=item itar

IANA's <itar> format, which is an XML-based format of trust anchor
keys.  IANA's file is available from https://itar.iana.org/.

=item libval

The I<libval> format is the configuration file format that
DNSSEC-Tool's I<libval> library uses.

=item mf

The master file (I<mf>) format is also available from the I<itar> web
site.

=back

=head1 OPTIONS

=over

=item B<-i STRING>

=item B<--input-file=STRING>

Input file(s) to process.

B<convertar> will read in the specified file(s).  Multiple files can
be separated by commas.

=item B<-o STRING>

=item B<--output-file=STRING>

Output file(s) to write.

B<convertar> will write out these specified file(s) in the requested
output formats.  Multiple files can be separated by commas.

=item B<-h>

=item B<--help>

=item B<--help-full>

Displays command line help information.

=item B<--gui>

=item B<--no-gui>

Controls the use of the optional GUI.

=back

=head1 COPYRIGHT

Copyright 2009 SPARTA, Inc.  All rights reserved.
See the COPYING file included with the DNSSEC-Tools package for details.

=head1 AUTHOR

Wes Hardaker < hardaker AT users DOT sourceforge DOT net >

=head1 SEE ALSO

I<Net::DNS::SEC::Tools::TrustAnchor>(3)

=cut

