			spfmilter-1.0.8 DNSSEC HOWTO
			============================
			       (Version 0.1)

Introduction
============

This HOWTO describes the installation, configuration and execution steps for
adding DNSSEC validation to sendmail using spfmilter-1.0.8.


Installation
============

Download spfmilter-1.0.8.tar.gz from http://www.libspf2.org/download.html.

Unzip and untar it by:

	tar -xvzf spfmilter-1.0.8.tar.gz

Go to the spfmilter-1.0.8 directory:

	cd spfmilter-1.0.8

Apply the spfmilter-1.0.8_dnssec_patch.txt patch found in this directory by:

	patch -p 0 -b -z .orig </path/to/patch/spfmilter-1.0.8_dnssec_patch.txt

This will apply the patch and store the original files with a .orig suffix.

Configure, compile and install spfmilter as per the instructions given in the
spfmilter-1.0.8 distribution.  The only change is that instead of installing
the original libspf2, you need to patch it with the libspf2-1.0.4_dnssec_patch
in ../libspf2-1.0.4_dnssec_patch.txt.  For instructions on how to do this, see
../libspf2-1.0.4_dnssec_howto.txt


Configuration
=============
Configure sendmail as per the instructions given in the spfmilter distribution.


Execution
=========

The dnssec patch adds a new command line option to spfmilter:

     -s <ignore|warn|reject>

     or

     --dnssec_policy=<ignore|warn|reject>

This option specifies the action spfmilter should take in the event of DNSSEC
validation failure.

If the option is

      --dnssec_policy=ignore

then DNSSEC validation will not take place.  This is the default if the
--dnssec_policy (or the -s) option is not specified on the command line.

If the option is

      --dnssec_policy=reject

then a DNSSEC validation failure will cause spfmilter to abort the processing
of the current email message, and send an error message back to the sender.
The receipent will not get an email.  The sendmail maillog file will show the
following error:

    "Error: DNSSEC validation of SPF record failed."

If the option is

      --dnssec_policy=warn

then the mail will get delivered to the receipent, even in the event of a
DNSSEC validation failure.  However, in this case the following warning     
message will be added to the SPF mail header:

    "problem=DNSSEC validation of SPF record failed."

The sendmail maillog file will also show the following warning:

    "problem=DNSSEC validation of SPF record failed."

In case of the 'reject' and 'warn' policies, if DNSSEC validation succeeds,
there is no DNSSEC validation error message in the SPF mail header or the maillog.
At present, the dnssec extension to spfmilter does not provide a 'success'
message.  Such an explicit DNSSEC validation success message will be added will
be added in a future release.  The absence of an error indication means success,
for now.

The policy is applied to all emails, irrespective of the sender or the
recepient.  Future versions may allow a more granular policy based on sender's
domain, sender's email address and/or the recepient's email address.

Use other options to spfmilter as per the instructions given in the
spfmilter distribution.


To Test
=======

1. Start spfmilter with the above dnssec patch applied
2. Start sendmail with the appropriate configuration for spfmilter

The following table gives a summary of the various scenarios.

+-----------------------------+----------------+--------------+---------------+
| Domain Characteristics      | Ignore Policy  | Warn Policy  | Reject Policy |
+-----------------------------+----------------+--------------+---------------+
|                             |                |              |               |
| No SPF Records              | No DNSSEC      | No DNSSEC    | No DNSSEC     |
|                             | Validation     | Validation   | Validation    |
|                             |      _/        |     _/       |      _/       |
+-----------------------------+----------------+--------------+---------------+
|                             |                |              |               |
| SPF Records present, but    | No DNSSEC      | Warning      | Error message |
| not a DNSSEC signed zone    | Validation     | message in   | in maillog.   |
|                             |                | mail header  | Mail dropped. |
|                             |                | and maillog  | Error message |
|                             |                |              | sent to sender|
|                             |      _/        |     _/       |      _/       |
+-----------------------------+----------------+--------------+---------------+
|                             |                |              |               |
| SPF Records present and     | No DNSSEC      | No error     | No error      |
| a DNSSEC signed zone        | Validation     | message in   | message in    |
|                             |                | mail header  | mail header   |
|                             |                | and maillog  | and maillog   |
|                             |      _/        |     _/       |      _/       |
+-----------------------------+----------------+--------------+---------------+

			 Table 1: Scenario Matrix
                         ========================

(Note: These are the only scenarios at present, since the DNSSEC validation
       is done by a place-holder algorithm that just tests for the presence of
       an RRSIG record.  More sophisticated scenarios will be supported later.)

Scenario 1:
-----------
Mails sent from a domain that does not have SPF records.

In this case, there is no SPF processing.  Hence, all mail will go through,
irrespective of the dnssec-policy in spfmilter.

The maillog file will not contain any indication of whether DNSSEC validation
succeeded or not.

Scenario 2:
-----------
Mails sent from a domain that has SPF records, but does not have DNSSEC signed
zones.

ignore policy:  DNSSEC validation will not be performed.  There will be no
indication about DNSSEC in either the maillog or the SPF mail header.

warn policy: A warning message will be added to the SPF mail header and the
sendmail maillog.

reject policy: An error message will be added to the sendmail maillog.  The
mail will be dropped and an error message will be returned to the sender.

Scenario 3:
-----------
Mails sent from a domain that has SPF records as well as DNSSEC signed zones.

ignore policy:  DNSSEC validation will not be performed.  There will be no
indication about DNSSEC in either the maillog or the SPF mail header.

warn policy: No DNSSEC validation error message will be added to the SPF mail
header or the sendmail maillog.

reject policy: No DNSSEC validation error message will be added to the SPF
mail header and the sendmail maillog.

===============================================================================
