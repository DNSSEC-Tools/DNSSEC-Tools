			spfmilter-1.0.8 DNSSEC HOWTO
			============================
			       (Version 0.1)

Introduction
============

This HOWTO describes the installation, configuration and execution steps for
adding DNSSEC validation to sendmail using spfmilter-1.0.8.


Installation
============

Download spfmilter-1.0.8.tar.gz from http://www.libspf2.org/download.html.

Unzip and untar it by:

	tar -xvzf spfmilter-1.0.8.tar.gz

Go to the spfmilter-1.0.8 directory:

	cd spfmilter-1.0.8

Apply the spfmilter-1.0.8_dnssec_patch.txt patch found in this directory by:

	patch -p 0 -b -z .orig </path/to/patch/spfmilter-1.0.8_dnssec_patch.txt

This will apply the patch and store the original files with a .orig suffix.

Before compiling, run 'autoconf' from the main spfmilter-1.0.8 directory to
generate a new 'configure' file.  Then, configure, compile and install
spfmilter as per the instructions given in the spfmilter-1.0.8 distribution.
The only change is that instead of installing the original libspf2, you need
to patch it with the libspf2-1.0.4_dnssec_patch given in
../libspf2-1.0.4_dnssec_patch.txt, and then install libspf2.  For instructions
on how to do this, see ../libspf2-1.0.4_dnssec_howto.txt


Configuration
=============
Configure sendmail as per the instructions given in the spfmilter distribution.


Execution
=========

The dnssec patch adds a new command line option to spfmilter:

     -s <ignore|warn|reject>

     or

     --dnssec_policy=<ignore|warn|reject>

This option specifies the action spfmilter should take in the event of DNSSEC
validation failure.

If the option is

      --dnssec_policy=ignore

then DNSSEC validation will not take place.  This is the default if the
--dnssec_policy (or the -s) option is not specified on the command line.

If the option is

      --dnssec_policy=reject

then a DNSSEC validation failure will cause spfmilter to abort the processing
of the current email message, and send an error message back to the sender.
The receipent will not get an email.  The sendmail maillog file will show the
following error:

    "Error: DNSSEC validation of SPF record failed."

If the option is

      --dnssec_policy=warn

then the mail will get delivered to the receipent, even in the event of a
DNSSEC validation failure.  However, in this case the following warning     
message will be added to the SPF mail header:

    "problem=DNSSEC validation of SPF record failed."

The sendmail maillog file will also show the following warning:

    "problem=DNSSEC validation of SPF record failed."

In case of the 'reject' and 'warn' policies, if DNSSEC validation succeeds,
there is no DNSSEC validation error message in the SPF mail header or the maillog.
At present, the dnssec extension to spfmilter does not provide a 'success'
message.  Such an explicit DNSSEC validation success message will be added will
be added in a future release.  The absence of an error indication means success,
for now.

The policy is applied to all emails, irrespective of the sender or the
recepient.  Future versions may allow a more granular policy based on sender's
domain, sender's email address and/or the recepient's email address.

Use other options to spfmilter as per the instructions given in the
spfmilter distribution.


To Test
=======

1. Start spfmilter with the above dnssec patch applied
2. Start sendmail with the appropriate configuration for spfmilter

(I) Basic Scenarios: DNSSEC validation of the SPF Records
---------------------------------------------------------
The following table gives a summary of the basic scenarios.

+-----------------------------+----------------+--------------+---------------+
| Domain Characteristics      | Ignore Policy  | Warn Policy  | Reject Policy |
+-----------------------------+----------------+--------------+---------------+
|                             |                |              |               |
| No SPF Records              | No DNSSEC      | No DNSSEC    | No DNSSEC     |
|                             | Validation     | Validation   | Validation    |
|                             |      _/        |     _/       |      _/       |
+-----------------------------+----------------+--------------+---------------+
|                             |                |              |               |
| SPF Records present, but    | No DNSSEC      | Warning      | Error message |
| not a DNSSEC signed zone    | Validation     | message in   | in maillog.   |
|                             |                | mail header  | Mail dropped. |
|                             |                | and maillog  | Error message |
|                             |                |              | sent to sender|
|                             |      _/        |     _/       |      _/       |
+-----------------------------+----------------+--------------+---------------+
|                             |                |              |               |
| SPF Records present and     | No DNSSEC      | No error     | No error      |
| a DNSSEC signed zone        | Validation     | message in   | message in    |
|                             |                | mail header  | mail header   |
|                             |                | and maillog  | and maillog   |
|                             |      _/        |     _/       |      _/       |
+-----------------------------+----------------+--------------+---------------+

			 Table 1: Basic Scenario Matrix
                         ==============================
	 (A _/ indicates that the scenario has been tested successfully.)

Scenario 1:
-----------
Mails sent from a domain that does not have SPF records.

In this case, there is no SPF processing.  Hence, all mail will go through,
irrespective of the dnssec-policy in spfmilter.

The maillog file will not contain any indication of whether DNSSEC validation
succeeded or not.

Scenario 2:
-----------
Mails sent from a domain that has SPF records, but does not have DNSSEC signed
zones.

ignore policy:  DNSSEC validation will not be performed.  There will be no
indication about DNSSEC in either the maillog or the SPF mail header.

warn policy: A warning message will be added to the SPF mail header and the
sendmail maillog.

reject policy: An error message will be added to the sendmail maillog.  The
mail will be dropped and an error message will be returned to the sender.

Scenario 3:
-----------
Mails sent from a domain that has SPF records as well as DNSSEC signed zones.

ignore policy:  DNSSEC validation will not be performed.  There will be no
indication about DNSSEC in either the maillog or the SPF mail header.

warn policy: No DNSSEC validation error message will be added to the SPF mail
header or the sendmail maillog.

reject policy: No DNSSEC validation error message will be added to the SPF
mail header and the sendmail maillog.


(II) Intermediate Scenarios: DNSSEC validation of the SPF Mechanisms
--------------------------------------------------------------------

These scenarios test various SPF mechanisms.  In this case, the primary
SPF record is signed.  However, the further records that it points to may
or may not be signed.  It is assumed that the mail is sent from an
IP address that is ultimately referenced by the DNS records i.e. in the
absence of DNSSEC validation, the SPF result will be a PASS.  However,
one or more intermediate DNS records may or may not be signed using DNSSEC.
This gives rise to many interesting scenarios, some of which are enumerated
in the following table along with their expected results.

+-----------+-----------------+----------------+--------------+---------------+
| Mechanism |   Conditions    | Ignore Policy  | Warn Policy  | Reject Policy |
+-----------+-----------------+----------------+--------------+---------------+
|           |                 |       _/       |     _/       |      _/       |
|           | Signed A record |      PASS      |    PASS      |     PASS      |
|     A     +-----------------+----------------+--------------+---------------+
|           |                 |       _/       |     _/       |      _/       |
|           | Unsigned A rec. |      PASS      | MAIL/WARNING | NO-MAIL/ABORT |
+-----------+-----------------+----------------+--------------+---------------+
|           |                 |       _/       |      _/      |      _/       |
|           | Signed MX rec.  |      PASS      |     PASS     |     PASS      |
|    MX     +-----------------+----------------+--------------+---------------+
|           |                 |       _/       |      _/      |      _/       |
|           | Unsigned MX rec.|      PASS      | MAIL/WARNING | NO-MAIL/ABORT |
+-----------+-----------------+----------------+--------------+---------------+
|           |                 |       _/       |      _/      |      _/       |
|           |Signed EXISTS rec|      PASS      |     PASS     |     PASS      |
|  EXISTS   +-----------------+----------------+--------------+---------------+
|           |    Unsigned     |       _/       |      _/      |      _/       |
|           | EXISTS record   |      PASS      | MAIL/WARNING | NO-MAIL/ABORT |
+-----------+-----------------+----------------+--------------+---------------+
|           |Signed INCLUDE re|       _/       |      _/      |      _/       |
|           |Signed A record  |      PASS      |     PASS     |     PASS      |
|           +-----------------+----------------+--------------+---------------+
|           |Signed INCLUDE re|       _/       |      _/      |      _/       |
|           |Unsigned MX rec. |      PASS      | MAIL/WARNING | NO-MAIL/ABORT |
+  INCLUDE  +-----------------+----------------+--------------+---------------+
|           |Unsigned INCLUDE |       _/       |      _/      |      _/       |
|           |Signed A rec.    |      PASS      | MAIL/WARNING | NO-MAIL/ABORT |
|           +-----------------+----------------+--------------+---------------+
|           |Unsigned INCLUDE |       _/       |      _/      |      _/       |
|           |Unsigned MX rec. |      PASS      | MAIL/WARNING | NO-MAIL/ABORT |
+-----------+-----------------+----------------+--------------+---------------+
|           |Signed REDIRECT  |       _/       |      _/      |      _/       |
|           |Signed A record  |      PASS      |     PASS     |     PASS      |
|           +-----------------+----------------+--------------+---------------+
|           |Signed REDIRECT  |       _/       |      _/      |      _/       |
|           |Unsigned MX rec. |      PASS      | MAIL/WARNING | NO-MAIL/ABORT |
|  REDIRECT +-----------------+----------------+--------------+---------------+
|           |Unsigned REDIRECT|       _/       |      _/      |      _/       |
|           |Signed A record  |      PASS      | MAIL/WARNING | NO-MAIL/ABORT |
|           +-----------------+----------------+--------------+---------------+
|           |Unsigned REDIRECT|       _/       |      _/      |      _/       |
|           |Unsigned MX rec. |      PASS      | MAIL/WARNING | NO-MAIL/ABORT |
+-----------+-----------------+----------------+--------------+---------------+
|           |                 |                |              |               |
|           |                 |                |              |               |
|    PTR    +-----------------+----------------+--------------+---------------+
|           |                 |                |              |               |
|           |                 |                |              |               |
+-----------+-----------------+----------------+--------------+---------------+

			 Table 2: Intermediate Scenario Matrix
			 =====================================
	 (A _/ indicates that the scenario has been tested successfully.)


(III) Advanced Scenario: Use of DNSSEC in SPAM filtering
--------------------------------------------------------

===============================================================================
