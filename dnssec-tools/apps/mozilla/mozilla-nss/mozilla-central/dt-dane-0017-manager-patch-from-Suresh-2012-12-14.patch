From 14417205b693b543df7bc006974835fb46ce489a Mon Sep 17 00:00:00 2001
From: Robert Story <rstory@localhost>
Date: Tue, 8 Jan 2013 00:24:32 -0500
Subject: [PATCH 17/22] DANE manager patch from Suresh; 2012-12-14

---
 security/manager/ssl/src/SSLServerCertVerification.cpp | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/security/manager/ssl/src/SSLServerCertVerification.cpp b/security/manager/ssl/src/SSLServerCertVerification.cpp
index 56ac90f..19a5b6c 100644
--- a/security/manager/ssl/src/SSLServerCertVerification.cpp
+++ b/security/manager/ssl/src/SSLServerCertVerification.cpp
@@ -1034,10 +1034,19 @@ SSLServerCertVerificationJob::Run()
   if (mInfoObject->isAlreadyShutDown()) {
     error = SEC_ERROR_USER_CANCELLED;
   } else {
+    SECStatus rv;
+    int do_pathval = 1;
+    int32_t port;
+    mInfoObject->GetPort(&port);
     // Reset the error code here so we can detect if AuthCertificate fails to
     // set the error code if/when it fails.
     PR_SetError(0, 0); 
-    SECStatus rv = AuthCertificate(mInfoObject, mCert);
+    rv = SSL_DANECheck(mInfoObject, (const char *)(mInfoObject->GetHostName()),
+            port, (CERTCertificate *)mCert, &do_pathval);
+
+    if (rv == SECSuccess && do_pathval) {
+        rv = AuthCertificate(mInfoObject, mCert);
+    }
     if (rv == SECSuccess) {
       nsRefPtr<SSLServerCertVerificationResult> restart 
         = new SSLServerCertVerificationResult(mInfoObject, 0);
-- 
1.7.11.7

