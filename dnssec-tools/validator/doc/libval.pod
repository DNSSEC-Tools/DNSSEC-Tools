
=pod

=head1 NAME

I<val_resolve_and_check()>, I<val_free_result_chain()> - query and validate
answers from a DNS name server

I<val_istrusted()> - check if status value corresponds to that of a
trustworthy answer

I<val_isvalidated()> - check if status value represents an
answer that was cryptographically validated up to a configured
trust anchor.

I<val_create_context()>, I<val_free_context()>, I<val_switch_policy_scope()> -
manage validator context

I<dnsval_conf_get()>, I<resolver_config_get()>, I<root_hints_get()> - get
the current location for the validator configuration files

I<dnsval_conf_set()>, I<resolver_config_set()>, I<root_hints_set()> - set
the current location for the validator configuration files

I<p_ac_status()>, I<p_val_status()> - display validator status information

=head1 SYNOPSIS

  #include <validator.h>

  int val_resolve_and_check(val_context_t            *context,
                            u_char                   *domain_name_n,
                            const u_int16_t          type,
                            const u_int16_t          class,
                            const u_int8_t           flags,
                            struct val_result_chain  **results);

  void val_free_result_chain(struct val_result *results);

  int val_istrusted(val_status_t val_status);

  int val_create_context(const char *label, val_context_t **newcontext);

  void val_free_context(val_context_t *context);

  char *resolver_config_get(void);

  int resolver_config_set(const char *name);

  char *root_hints_get(void);

  int root_hints_set(const char *name);

  char *dnsval_conf_get(void);

  int dnsval_conf_set(const char *name);

  char *p_ac_status(val_astatus_t valerrno);

  char *p_val_status(val_status_t valerrno);

=head1 DESCRIPTION

The I<val_resolve_and_check()> function queries a set of name servers for
the I<<domain_name_n, type, class>> tuple and to verifies and validates the
response.  Verification involves checking the RRSIGs, and validation is
verification up the chain-of-trust to a trust anchor.  The I<domain_name_n>
parameter is the queried name in DNS wire format.  The conversion from host
format to DNS wire format can be done using the  I<ns_name_pton()> function
exported by the I<libsres(3)> library.

Answers returned by I<val_resolve_and_check()> are made available in the
I<*results> array.  Each answer is a distinct RRset; multiple RRs within the
RRset are treated as the same answer.  Multiple answers are possible when
I<type> is I<ns_t_any>.

Individual elements in I<*results> point to the authentication chain contained
within the I<val_authentication_chain> linked list.  The authentication chain
elements contain the actual RRsets returned by the name server in response to
the query.

Most applications only require the status value within I<*results> since this
provides a single error code for representing the authenticity of returned
data.  Other more intrusive applications, such as a DNSSEC troubleshooting
utility, may look at individual authentication chain elements to identify what
particular component in the chain-of-trust led to a validation failure.
I<val_istrusted()> is a helper function that easily identifies if a given
validator status value corresponds to one of the authenticated and/or trusted
data codes.  Validator status values returned in the I<val_result_chain> and
I<val_authentication_chain> linked lists can be can be converted into ASCII
format using the I<p_val_status()> and I<p_ac_status()> functions.

The I<libval> library internally allocates memory for I<*results> and this
must be freed by the invoking application using the I<free_result_chain()>
interface.

The first parameter to I<val_resolve_n_check()> is the validator context.
Applications can create a new validator context using the
I<val_create_context()> function.  This function parses the resolver and
validator configuration files and creates the handle I<newcontext> to this
parsed information.  Information stored as part of validator context includes
the validation policy and resolver policy.  Validator and resolver policy are
read by default from the B</etc/dnsval.conf> and B</etc/resolv.conf> files.
"Root hints" that allows the library to bootstrap its lookup process when
functioning as a full resolver is read from B</etc/root.hints>.  The locations
of each of these files may be changed using the interfaces
I<dnsval_conf_set()>, I<resolver_config_set()>, and I<root_hints_set()>,
respectively.  The corresponding "get" interfaces (namely
I<dnsval_conf_get()>, I<resolver_config_get()>, and I<root_hints_get()>) can be
used to return the current location from where these configuration files are
read.

Applications can use local policy to influence the validation outcome.
Examples of local policy elements include trust anchors for different zones
and untrusted algorithms for cryptographic keys and hashes.  Local policy
may vary for different applications and operating scenarios.

Local policy for the validator is stored in the configuration file,
B</etc/dnsval.conf>.  Policies are identified by simple text strings called
labels, which must be unique within the configuration system.  For example,
"browser" could be used as the label that defines the validator policy for all
web-browsers in a system.  A label value of ":" identifies the default policy,
the policy that is used when a NULL context is specified as the I<ctx>
parameter for interfaces such as I<val_resolve_and_check()>,
I<val_getaddrinfo()>, and I<val_gethostbyname()>.  The default policy is
unique within the configuration system.

=head1 DATA STRUCTURES

=over 4

=item I<struct val_result_chain>

  struct val_result_chain
  { 
      val_status_t                     val_rc_status;
      struct val_authentication_chain *val_rc_answer;
      int                              val_rc_proof_count;
      struct val_authentication_chain *val_rc_proofs[MAX_PROOFS];
      struct val_result_chain         *val_rc_next;
  };

=over 4


=item I<val_rc_answer> 

Authentication chain for a given RRset.

=item I<val_rc_next> 

Pointer to the next RRset in the set of answers returned for a query.

=item I<val_rc_proofs> 

Pointer to any proofs that were returned for the query.

=item I<val_rc_proof_count> 

Number of proof elements stored in I<val_rc_proofs>.

=item I<val_rc_status> 

Validation status for a given RRset.  This can be one of the following:

	VAL_SUCCESS
		Answer received and validated successfully.

	VAL_LOCAL_ANSWER
		Answer was available from a local file.

	VAL_BARE_RRSIG
		No DNSSEC validation possible, query was
		for an RRSIG.

	VAL_NONEXISTENT_NAME        
		No name was present and a valid proof of
		non-existence confirming the missing name
		(NSEC or NSEC3 span) was returned. The 
        components of the proof were also 
        individually validated. 

	VAL_NONEXISTENT_TYPE
		No type exists for the name and a valid
		proof of non-existence confirming the
		missing name (NSEC or NSEC3 span) was
		returned.  The components of the proof 
        were also individually validated. 

	VAL_NONEXISTENT_NAME_NOCHAIN
		No name was present and a valid proof of
		non-existence confirming the missing name
		(NSEC or NSEC3 span) was returned. The 
        components of the proof were also 
        identified to be trustworthy, but they 
        were not individually validated.

	VAL_NONEXISTENT_TYPE_NOCHAIN
		No type exists for the name and a valid
		proof of non-existence confirming the
		missing name (NSEC or NSEC3 span) was
		returned.  The components of the proof 
        were also identified to be trustworthy, 
        but they were not individually validated. 

	VAL_ERROR
		Did not have sufficient or relevant data to
		complete validation, or encountered a DNS error.

	VAL_DNS_ERROR_BASE + SR_error

		This value contains a resolver error from 
		libsres. The libsres error is added to 
		VAL_DNS_ERROR_BASE, so this value will lie 
		between VAL_DNS_ERROR_BASE and 
		VAL_DNS_ERROR_LAST.

	VAL_INDETERMINATE
		Lacking information to give a more conclusive
		answer.

	VAL_BOGUS
		Validation failure condition.

	VAL_NOTRUST
		All available components in the authentication
		chain verified properly, but there was no trust
		anchor available.
	
	VAL_IGNORE_VALIDATION
		 Local policy was configured to ignore 
		 validation for the zone from which this data 
		 was received.

	VAL_TRUSTED_ZONE
		 Local policy was configured to trust 
		 any data received from the given zone. 
         
	VAL_UNTRUSTED_ZONE
		 Local policy was configured to reject 
		 any data received from the given zone. 

	VAL_PROVABLY_UNSECURE
		The record or some ancestor of the record in
		the authentication chain towards the trust
		anchor was known to be provably unsecure.


Error values in I<val_status_t> returned by the validator can be displayed 
in a more user-friendly format using I<p_val_status()>.

=back

=back

=over 4

=item I<struct val_authentication_chain>

  struct val_authentication_chain
  {
      val_astatus_t                    val_ac_status;
      struct val_rrset                *val_ac_rrset;
      struct val_authentication_chain *val_ac_trust;
  };

=over 4

=item I<val_ac_status> 

Validation state of the authentication chain element.  This field will
contain the error or success code for DNSSEC validation over the current
authentication chain element upon completion of I<val_resolve_n_check()>.
This field may contain the following values:

      VAL_AC_UNSET
		The status was not set.

      VAL_AC_DATA_MISSING
		No data were returned for a query and the
		DNS did not indicate an error.

      VAL_AC_RRSIG_MISSING
		RRSIG data could not be retrieved for a
		resource record.

      VAL_AC_DNSKEY_MISSING
		The DNSKEY for an RRSIG covering a resource
		record could not be retrieved.

      VAL_AC_DS_MISSING
		The DS record covering a DNSKEY record was
		not available.

      VAL_AC_UNTRUSTED_ZONE
		Local policy defined a given zone as
		untrusted, with no further validation
		being deemed necessary.

      VAL_AC_UNKNOWN_DNSKEY_PROTOCOL
		The DNSKEY protocol number was unrecognized.

      VAL_AC_NOT_VERIFIED
		All RRSIGs covering the RRset could not
		be verified.

      VAL_AC_VERIFIED
		At least one RRSIG covering a resource
		record had a status of VAL_AC_RRSIG_VERIFIED.

      VAL_AC_LOCAL_ANSWER
		The answer was obtained locally (e.g., from
		/etc/hosts) and validation was not performed
		on the results.

      VAL_AC_TRUST_KEY
		A given DNSKEY or a DS record was locally
		defined to be a trust anchor.

      VAL_AC_IGNORE_VALIDATION
		Validation for the given resource record
		was ignored, either because of some
		local policy directive or because of
		some protocol-specific behavior.

      VAL_AC_TRUSTED_ZONE
		Local policy defined a given zone as
		trusted, with no further validation
		being deemed necessary.

      VAL_AC_PROVABLY_UNSECURE
		The authentication chain from a trust anchor
		to a given zone could not be constructed due
		to the provable absence of a DS record for
		this zone in the parent.

      VAL_AC_BARE_RRSIG
		The response was for a query of type RRSIG.
		RRSIGs contain the cryptographic signatures
		for other DNS data and cannot themselves
		be validated.

      VAL_AC_NO_TRUST_ANCHOR
		There was no trust anchor configured for a
		given authentication chain.

      VAL_DNS_ERROR_BASE + SR_error

		This value contains a resolver error from
		libsres.  The libsres error is added to
		VAL_DNS_ERROR_BASE, so this value will lie
		between VAL_DNS_ERROR_BASE and
		VAL_DNS_ERROR_LAST.  These values include
		the following:

		    SR_CONFLICTING_ANSWERS	
			Multiple conflicting answers
			received for a query.

		    SR_REFERRAL_ERROR
			Some error encountered while
			following referrals.

		    SR_MISSING_GLUE
			Glue was missing.

=item I<val_ac_rrset> 

Pointer to an RRset of type I<struct val_rrset> obtained from the DNS response.

=item I<val_ac_trust> 

Pointer to an authentication chain element that either contains a DNSKEY RRset
that can be used to verify RRSIGs over the current record, or contains a DS
RRset that can be used to build the chain-of-trust towards a trust anchor.

=back

=back

=over 4

=item I<struct val_rrset>

  struct val_rrset
  {
      u_int8_t      *val_msg_header; 
      u_int16_t      val_msg_headerlen;
      u_int8_t      *val_rrset_name_n; 
      u_int16_t      val_rrset_class_h;
      u_int16_t      val_rrset_type_h;
      u_int32_t      val_rrset_ttl_h;
      u_int8_t       val_rrset_section;
      struct rr_rec *val_rrset_data;
      struct rr_rec *val_rrset_sig;
  };

=over 4

=item I<val_msg_header> 

Header of the DNS response in which the RRset was received.

=item I<val_msg_headerlen> 

Length of the header information in I<val_msg_header>.

=item I<val_rrset_name_n> 

Owner name of the RRset represented in on-the-wire format.

=item I<val_rrset_class_h> 

Class of the RRset.

=item I<val_val_rrset_type_h> 

Type of the RRset.

=item I<val_rrset_ttl_h> 

TTL of the RRset.

=item I<val_rrset_section> 

Section in which the RRset was received -- B<VAL_FROM_ANSWER>,
B<VAL_FROM_AUTHORITY>, or B<VAL_FROM_ADDITIONAL>.

=item I<val_rrset_data> 

Response RDATA.

=item I<val_rrset_sig> 

Any associated RRSIGs for the RDATA returned in I<val_rrset_data>.

=back
=back

=over 4

=item I<struct rr_rec>

  struct rr_rec
  {
      u_int16_t        rr_rdata_length_h;  
      u_int8_t        *rr_rdata;      
      val_astatus_t    rr_status;
      struct rr_rec   *rr_next;
  };

=over 4

=item I<rr_rdata_length_h> 

Length of data stored in I<rr_rdata>.

=item I<rr_rdata> 

RDATA bytes.

=item I<rr_status> 

For each signature I<rr_rec> member within the authentication chain
I<val_ac_rrset>, the validation status stored in the variable
I<rr_status> can return one of the following values:

      VAL_AC_RRSIG_VERIFIED - The RRSIG verified
		successfully.

      VAL_AC_WCARD_VERIFIED - A given RRSIG covering
		a resource record shows that the
		record was wildcard expanded.

      VAL_AC_RRSIG_VERIFY_FAILED - A given RRSIG
		covering an RRset was bogus.

      VAL_AC_DNSKEY_NOMATCH - An RRSIG was created
		by a DNSKEY that did not exist in
		the apex keyset.

      VAL_AC_RRSIG_ALGORITHM_MISMATCH - The keytag
		referenced in the RRSIG matched a
		DNSKEY but the algorithms were different.

      VAL_AC_WRONG_LABEL_COUNT - The number of labels
		on the signature was greater than the
		count given in the RRSIG RDATA.

      VAL_AC_BAD_DELEGATION - An RRSIG was created
		with a key that did not exist in
		the parent DS record set.

      VAL_AC_RRSIG_NOTYETACTIVE - The RRSIG's inception
		time is in the future.

      VAL_AC_RRSIG_EXPIRED - The RRSIG had expired.

      VAL_AC_INVALID_RRSIG - The RRSIG could not be parsed.

      VAL_AC_ALGORITHM_NOT_SUPPORTED - The RRSIG
		algorithm was not supported.

      VAL_AC_UNKNOWN_ALGORITHM - The RRSIG algorithm
		was unknown.

      VAL_AC_ALGORITHM_REFUSED - The RRSIG algorithm
		was not allowed as per local policy.

For each I<rr_rec> member of type DNSKEY (or DS, where relevant) within the
authentication chain I<val_ac_rrset>, the validation status is stored in the
variable I<rr_status> and can return one of the following values:

      VAL_AC_SIGNING_KEY - This DNSKEY was used to
		create an RRSIG for the resource
		record set.

      VAL_AC_VERIFIED_LINK - This DNSKEY provided the
		link in the authentication chain from
		the trust anchor to the signed record.

      VAL_AC_UNKNOWN_ALGORITHM_LINK - This DNSKEY provided
		the link in the authentication chain from
		the trust anchor to the signed record, but
		the DNSKEY algorithm was unknown.

      VAL_AC_INVALID_KEY - The key used to verify the
		RRSIG was not a valid DNSKEY.

      VAL_AC_KEY_TOO_LARGE - Local policy defined the
		DNSKEY size as being too large.

      VAL_AC_KEY_TOO_SMALL - Local policy defined the
		DNSKEY size as being too small.

      VAL_AC_KEY_NOT_AUTHORIZED - Local policy defined the
		DNSKEY to be unauthorized for validation.

      VAL_AC_ALGORITHM_NOT_SUPPORTED - The DNSKEY or DS
		algorithm was not supported.

      VAL_AC_UNKNOWN_ALGORITHM - The DNSKEY or DS
		algorithm was unknown.

      VAL_AC_ALGORITHM_REFUSED - The DNSKEY or DS algorithm
		was not allowed as per local policy.

=back

=item I<rr_next> 

Points to the next resource record in the RRset.

=back

=back

=head1 RETURN VALUES

Return values for I<val_resolve_n_check()> and I<val_create_context()> are
given below.

=over 4

=item I<val_resolve_n_check()>

=over 4

=item VAL_NO_ERROR

No error was encountered.

=item VAL_GENERIC_ERROR   

Generic error encountered.

=item VAL_NOT_IMPLEMENTED 

Functionality not yet implemented.

=item VAL_BAD_ARGUMENT

Bad arguments passed as parameters.

=item VAL_INTERNAL_ERROR

Encountered some internal error.

=item VAL_NO_PERMISSION 

No permission to perform operation.  Currently not implemented.

=item VAL_RESOURCE_UNAVAILABLE

Some resource (crypto possibly) was unavailable.  Currently not implemented.

=back

=item I<val_create_context()>

=over 4

=item VAL_NO_ERROR

No error was encountered.

=item VAL_RESOURCE_UNAVAILABLE 

Could not allocate memory.

=item VAL_CONF_PARSE_ERROR

Error in parsing some configuration file.

=item VAL_CONF_NOT_FOUND 

A configuration file was not available.

=item VAL_NO_POLICY 

The policy identifier being referenced was invalid.

=back

=back

=head1 FILES

The validator library reads configuration information from two files,
B</etc/resolv.conf> and B</etc/dnsval.conf>.

Only the "nameserver" option is supported in the B<resolv.conf> file.  This
option is used to specify the IP address of the name server to which queries
must be sent by default.  For example,

    nameserver 10.0.0.1

See B<dnsval.conf(5)> for a description of the validator configuration file.

=head1 CURRENT STATUS

There is currently no support for IPv6.

The caching functionality is very basic and no timeout logic currently exists.

There are a number of feature enhancements that still remain to be done.

=head1 COPYRIGHT

Copyright 2004-2006 SPARTA, Inc.  All rights reserved.
See the COPYING file included with the dnssec-tools package for details.

=head1 SEE ALSO

I<libsres(3)>

B<dnsval.conf(5)>

http://dnssec-tools.sourceforge.net

=cut	
