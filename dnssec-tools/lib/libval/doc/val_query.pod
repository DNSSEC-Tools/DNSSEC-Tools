=pod

=head1 NAME

val_query, val_x_query - DNSSEC-validated resolution of DNS queries

=head1 SYNOPSIS

  #include <validator.h>

  int val_query(const char *domain_name, int class, int type,
              unsigned char *answer, int anslen, int flags,
              int *dnssec_status);

  int val_x_query(const val_context_t *ctx,
            const char *domain_name, const u_int16_t class,
            const u_int16_t type, const u_int8_t flags,
            struct response_t *resp, int *resp_count)

=head1 DESCRIPTION

The B<val_query()> function is a DNSSEC-aware version of B<res_query(3)>.
It performs DNSSEC validation of DNS queries.  The results of the DNSSEC
validation are returned in the I<dnssec_status> parameter.  The caller must
not pass a NULL value for this parameter.

The I<flags> parameter is reserved for future use, and must be set to 0 at
present.

If DNSSEC validation succeeds, a value of B<VALIDATE_SUCCESS> is returned in
I<dnssec_status>.  Other values are returned in case of errors.  See
B<val_errors.h> for a listing of possible error codes.  The B<p_val_error()>
function can be used to return a brief string description of the error code.

B<val_query()> gives applications that already use the B<res_query(3)>
interface a simple way to transition towards being DNSSEC-aware.  It does
not, however, handle cases where multiple resource record sets may be returned
for a query, each with a potentially different DNSSEC status.  If such
functionality is desired, applications must make use of the B<val_x_query()>
interface.  The only difference between this and B<val_query()> is that the
latter returns results in I<resp> which encapsultes the results into the
following structure:

  struct response_t {
        u_int8_t *response;
        int response_length;
        int validation_result;
  }; 

I<response>, I<response_length> and I<validation_result> are functionally
similar to I<answer>, I<anslen> and I<dnssec_status> respectively.  I<resp>
is an array and must be allocated by the user to be of sufficient size to
hold all the answers returned by the DNS name server.

The number of answers actually available is returned in the I<resp_count>
parameter.  In case I<resp> is not large enough to hold all answers returned
from B<val_x_query()>, it returns an error code of B<NO_SPACE> and
I<resp_count> is set to the total number of answers available.  Applications
may re-query after reallocating I<resp> to hold that many answers.  For
queries that are not of type C<ns_t_any> it is generally sufficient to
allocate an array of three elements for *I<results>.

The I<ctx> parametr is the validator context and can be set to NULL for
default settings.  More information about this field can be found in
B<libval(3)>.

=head1 RETURN VALUES

The B<val_query()> function returns the length of the answer if successful,
or -1 if there was an error.

The B<val_x_query()> function returns B<NO_ERROR> on success.  It returns
B<NO_SPACE> if the application has not allocated enough memory to hold all
results returned by the validator.  This function internally invokes
B<resolve_n_check()>, and errors from this function may also be returned.
See B<libval(3)> for more details.

=head1 EXAMPLES
 
 #include <stdio.h>
 #include <strings.h>
 #include <arpa/nameser.h>
 #include <validator.h>
 
 #define BUFLEN 8096

 int main(int argc, char *argv[])
 {
          int dnssec_status = ERROR;
          int anslen = NETDB_INTERNAL;
          int class = ns_c_in;
          int type = ns_t_a;
          char buf[BUFLEN];

          bzero(buf, BUFLEN);

          if (argc < 2) {
                  printf("Usage: %s <domain-name>\n", argv[0]);
                  exit(1);
          }
 
          anslen = val_query(argv[1], class, type, buf, BUFLEN,
                             0, &dnssec_status);

          if (anslen > 0) {
                  printf("DNSSEC Status = %d [%s]\n", dnssec_status,
                         p_val_error(dnssec_status));
          }

          return 0;
 }

=head1 NOTES

The B<val_query()> function does not handle the case when the response to
a query contains an answer section having records of different types.  For
example, it returns -1 if the response contains both CNAME and A records
in the answer section.  This will be fixed in future versions of the library.

=head1 COPYRIGHT

Copyright 2004-2005 SPARTA, Inc.  All rights reserved.
See the COPYING file included with the DNSSEC-Tools package for details.

=head1 AUTHORS

Abhijit Hayatnagarkar, Suresh Krishnaswamy.

=head1 SEE ALSO

B<res_query(3)>

B<get_context(3)>, B<val_getaddrinfo(3)>, B<val_gethostbyname(3)>

I<p_val_error>

B<libval(3)>

http://dnssec-tools.sourceforge.net

=cut
