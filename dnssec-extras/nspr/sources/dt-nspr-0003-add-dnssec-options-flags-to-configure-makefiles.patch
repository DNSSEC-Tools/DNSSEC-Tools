From b59748848164856c0a72001c1bd162fc78eb2a69 Mon Sep 17 00:00:00 2001
From: Robert Story <rstory@localhost>
Date: Wed, 11 Apr 2012 14:13:53 -0400
Subject: [PATCH 03/16] NSPR dnssec options/flags to configure/makefiles

---
 nsprpub/config/autoconf.mk.in | 12 ++++--
 nsprpub/config/config.mk      |  5 +++
 nsprpub/config/nspr-config.in |  6 +--
 nsprpub/configure.in          | 97 +++++++++++++++++++++++++++++++++++++++++++
 nsprpub/pr/tests/Makefile.in  |  6 +++
 5 files changed, 119 insertions(+), 7 deletions(-)

diff --git a/nsprpub/config/autoconf.mk.in b/nsprpub/config/autoconf.mk.in
index 5f093c4..547287b 100644
--- a/nsprpub/config/autoconf.mk.in
+++ b/nsprpub/config/autoconf.mk.in
@@ -80,10 +80,10 @@ CYGWIN_WRAPPER	= @CYGWIN_WRAPPER@
 MT		= @MT@
 
 OS_CPPFLAGS	= @CPPFLAGS@
-OS_CFLAGS	= $(OS_CPPFLAGS) @CFLAGS@ $(DSO_CFLAGS)
-OS_CXXFLAGS	= $(OS_CPPFLAGS) @CXXFLAGS@ $(DSO_CFLAGS)
-OS_LIBS         = @OS_LIBS@
-OS_LDFLAGS	= @LDFLAGS@
+OS_CFLAGS	= $(OS_CPPFLAGS) @CFLAGS@ $(DSO_CFLAGS) $(VAL_CFLAGS)
+OS_CXXFLAGS	= $(OS_CPPFLAGS) @CXXFLAGS@ $(DSO_CFLAGS) $(VAL_CFLAGS)
+OS_LIBS         = @OS_LIBS@ $(VAL_LIBS)
+OS_LDFLAGS	= @LDFLAGS@ $(VAL_LDFLAGS)
 OS_DLLFLAGS	= @OS_DLLFLAGS@
 DLLFLAGS	= @DLLFLAGS@
 EXEFLAGS  = @EXEFLAGS@
@@ -99,6 +99,10 @@ WRAP_LDFLAGS	= @WRAP_LDFLAGS@
 DSO_CFLAGS	= @DSO_CFLAGS@
 DSO_LDOPTS	= @DSO_LDOPTS@
 
+VAL_CFLAGS	= @VAL_CFLAGS@
+VAL_LDFLAGS	= @VAL_LDFLAGS@ $(VAL_LIBS)
+VAL_LIBS	= @VAL_LIBS@
+
 RESOLVE_LINK_SYMBOLS = @RESOLVE_LINK_SYMBOLS@
 
 HOST_CC		= @HOST_CC@
diff --git a/nsprpub/config/config.mk b/nsprpub/config/config.mk
index 05db076..9807860 100644
--- a/nsprpub/config/config.mk
+++ b/nsprpub/config/config.mk
@@ -63,6 +63,11 @@ endif
 endif # MOZ_PROFILE_USE
 endif # NO_PROFILE_GUIDED_OPTIMIZE
 
+ifdef MOZ_DNSSEC
+CFLAGS += $(VAL_CFLAGS)
+LDFLAGS += $(VAL_LDFLAGS)
+endif # MOZ_DNSSEC
+
 define MAKE_OBJDIR
 if test ! -d $(@D); then rm -rf $(@D); $(NSINSTALL) -D $(@D); fi
 endef
diff --git a/nsprpub/configure.in b/nsprpub/configure.in
index da7961c..23609b0 100644
--- a/nsprpub/configure.in
+++ b/nsprpub/configure.in
@@ -2678,6 +2678,7 @@ dnl AC_HEADER_STDC
 dnl AC_HEADER_SYS_WAIT
 dnl AC_CHECK_HEADERS(fcntl.h limits.h sys/file.h sys/ioctl.h sys/time.h unistd.h)
 
+
 dnl ========================================================
 dnl Check for typedefs and structs
 dnl ========================================================
@@ -3196,6 +3197,102 @@ AC_ARG_WITH(wrap-malloc,
     WRAP_LDFLAGS="${WRAP_LDFLAGS} $withval")
 
 dnl ========================================================
+dnl = Add DNSSEC support
+dnl ========================================================
+
+AC_ARG_WITH(system-val,
+[  --with-system-val[=PFX]
+                  Use system DNSSEC validator [installed at prefix PFX]],
+   ,
+   [with_system_val=no])
+
+AC_ARG_WITH(system-openssl,
+[  --with-system-openssl[=PFX]
+                  Use system openssl libraries [installed at prefix PFX]],
+   ,
+   [with_system_openssl=no])
+
+_SAVE_LDFLAGS="$LDFLAGS"
+_SAVE_CFLAGS="$CFLAGS"
+VAL_LIBS=""
+VAL_CFLAGS=""
+VAL_LDFLAGS=""
+OPENSSL_LIBS=""
+if test "x$with_system_val" != xno; then
+  if test "x$USE_64" = x1; then
+     LIBDIR="lib64"
+  else
+     LIBDIR="lib"
+  fi
+  if test "x$with_system_val" != xyes; then
+    VAL_CFLAGS="-I${with_system_val}/include"
+    VAL_LDFLAGS="-L${with_system_val}/$LIBDIR"
+  fi
+  if test -n "$_WIN32_MSVC"; then
+    VAL_LIBS="${with_system_val}/lib/libval-threads.a ${with_system_val}/lib/libsres.a ${with_system_val}/lib/libcrypto.a ${with_system_val}/lib/libpthread.dll.a ${with_system_val}/lib/libgcc.a user32.lib gdi32.lib Ws2_32.lib"
+    AC_DEFINE(MOZ_DNSSEC)
+  else
+    if test "x$with_system_openssl" != xno; then
+        if test "x$with_system_openssl" != xyes; then
+            CFLAGS="$CFLAGS -I${with_system_openssl}/include"
+            LDFLAGS="$LDFLAGS -L${with_system_openssl}/$LIBDIR"
+            OPENSSL_PATH="${with_system_openssl}"
+        else
+            OPENSSL_PATH="/usr/$LIBDIR"
+        fi
+    else
+        OPENSSL_PATH="/usr/$LIBDIR"
+    fi
+    LDFLAGS="$LDFLAGS $VAL_LDFLAGS"
+    CFLAGS="$CFLAGS $VAL_CFLAGS"
+    AC_CHECK_LIB(crypto, EVP_md5, OPENSSL_LIBS="-lcrypto")
+
+    dnl look for static lib
+    AC_CHECK_LIB(ssl, SSL_get_SSL_CTX, OPENSSL_LIBSSL="yes")
+    if test -n "$OPENSSL_LIBSSL"; then
+      OPENSSL_LIBS="$OPENSSL_LIBS $OPENSSL_PATH/libssl.a"
+    fi
+
+    dnl with static openssl, apparently we need to pull in libkrb5
+    AC_CHECK_LIB(krb5, krb5_init_context, OPENSSL_LIBS="$OPENSSL_LIBS -lkrb5")
+    AC_CHECK_LIB(k5crypto, krb5_checksum_size, OPENSSL_LIBS="$OPENSSL_LIBS -lk5crypto")
+
+    dnl val-threads check
+    AC_CHECK_LIB(val-threads, val_gethostbyname,
+        [VAL_LIBS="-lval-threads -lsres ${OPENSSL_LIBS} ${_PTHREAD_LDFLAGS}"
+         AC_DEFINE(MOZ_DNSSEC)], ,
+        -lsres ${OPENSSL_LIBS} ${_PTHREAD_LDFLAGS})
+  fi
+  dnl functions added in 1.11
+  AC_CHECK_LIB(val-threads, val_getaddrinfo_submit,
+                AC_DEFINE(HAVE_VAL_GETADDRINFO_SUBMIT), ,
+                -lsres ${OPENSSL_LIBS} ${_PTHREAD_LDFLAGS})
+  dnl functions added in 1.12
+  AC_CHECK_LIB(val-threads, val_context_setqflags,
+                AC_DEFINE(HAVE_VAL_CONTEXT_SETQFLAGS), ,
+                -lsres ${OPENSSL_LIBS} ${_PTHREAD_LDFLAGS})
+
+  dnl functions added in 1.13
+  AC_CHECK_LIB(val-threads, val_freeaddrinfo,
+                AC_DEFINE(HAVE_VAL_FREEADDRINFO), ,
+                -lsres ${OPENSSL_LIBS} ${_PTHREAD_LDFLAGS})
+  AC_CHECK_LIB(val-threads, val_getaddrinfo_cancel,
+                AC_DEFINE(HAVE_VAL_GETADDRINFO_CANCEL), ,
+                -lsres ${OPENSSL_LIBS} ${_PTHREAD_LDFLAGS})
+fi
+LDFLAGS="$_SAVE_LDFLAGS"
+CFLAGS="$_SAVE_CFLAGS"
+
+AC_SUBST(VAL_LIBS)
+AC_SUBST(VAL_CFLAGS)
+AC_SUBST(VAL_LDFLAGS)
+AC_SUBST(HAVE_VAL_CONTEXT_SETQFLAGS)
+AC_SUBST(HAVE_VAL_GETADDRINFO_SUBMIT)
+AC_SUBST(HAVE_VAL_FREEADDRINFO)
+AC_SUBST(HAVE_VAL_GETADDRINFO_CANCEL)
+AC_SUBST(MOZ_DNSSEC)
+
+dnl ========================================================
 dnl Substitution of found variables.
 dnl ========================================================
 AC_SUBST(SHELL_OVERRIDE)
diff --git a/nsprpub/pr/tests/Makefile.in b/nsprpub/pr/tests/Makefile.in
index 122ef1c..6cd7842 100644
--- a/nsprpub/pr/tests/Makefile.in
+++ b/nsprpub/pr/tests/Makefile.in
@@ -423,6 +423,10 @@ LIBPTHREAD =
 XCFLAGS = $(OS_CFLAGS)
 endif
 
+ifneq ($(VAL_LIBS),)
+EXTRA_LIBS += $(OS_LDFLAGS) $(OS_LIBS)
+endif
+
 #####################################################
 #
 # The rules
@@ -504,6 +508,8 @@ $(OBJDIR)/socket: $(OBJDIR)/socket.o
 	$(PURE) $(CC) $(XCFLAGS) $< $(LDOPTS) $(LIBPLC) $(LIBNSPR) $(LIBPTHREAD) $(EXTRA_LIBS) -o $@
 $(OBJDIR)/testfile: $(OBJDIR)/testfile.o
 	$(PURE) $(CC) $(XCFLAGS) $< $(LDOPTS) $(LIBPLC) $(LIBNSPR) $(LIBPTHREAD) $(EXTRA_LIBS) -o $@
+$(OBJDIR)/getai: $(OBJDIR)/getai.o
+	$(PURE) $(CC) $(XCFLAGS) $(DEFINES) $< $(LDOPTS) $(LIBPLC) $(LIBNSPR) $(LIBPTHREAD) $(EXTRA_LIBS) -o $@
 endif
 
 #
-- 
1.7.11.7

