From 6a7a475318382409f6c655f8152dd5bd890e25f8 Mon Sep 17 00:00:00 2001
From: Robert Story <rstory@localhost>
Date: Mon, 4 Jun 2012 15:55:16 -0400
Subject: [PATCH 6/6] add DNSSEC preferences to browser

---
 browser/components/preferences/advanced.xul        |   20 ++++++++++++++++++++
 .../en-US/chrome/browser/preferences/advanced.dtd  |   10 ++++++++++
 layout/base/nsPresContext.cpp                      |   16 ++++++++++++++++
 3 files changed, 46 insertions(+), 0 deletions(-)

diff --git a/browser/components/preferences/advanced.xul b/browser/components/preferences/advanced.xul
index 0e8fb38..6e81414 100644
--- a/browser/components/preferences/advanced.xul
+++ b/browser/components/preferences/advanced.xul
@@ -133,6 +133,9 @@
       <preference id="security.disable_button.openDeviceManager"
                   name="security.disable_button.openDeviceManager"
                   type="bool"/>
+      <preference id="security.dnssec.dnssecBehavior"
+                  name="security.dnssec.dnssecBehavior"
+                  type="int"/>
     </preferences>
     
 #ifdef HAVE_SHELL_SERVICE
@@ -150,6 +153,7 @@
         <tab id="networkTab" label="&networkTab.label;" helpTopic="prefs-advanced-network"/>
         <tab id="updateTab" label="&updateTab.label;"  helpTopic="prefs-advanced-update"/>
         <tab id="encryptionTab" label="&encryptionTab.label;" helpTopic="prefs-advanced-encryption"/>
+        <tab id="dnssecTab" label="&dnssecTab.label;" helpTopic="prefs-advanced-dnssec"/>
       </tabs>
 
       <tabpanels flex="1">
@@ -441,6 +445,22 @@
           </groupbox>
         </tabpanel>
 
+        <tabpanel orient="vertical">
+          <groupbox>
+            <caption label="&dnsSecurity.label;"/>
+            <description>&dnssec.description;</description>
+           <radiogroup id="networkDnssecBehaviour"
+                       preference="security.dnssec.dnssecBehavior">
+             <radio value="2" label="&allDNSSecure.label;"
+                    accesskey="&allDNSSecure.accesskey;"/>
+             <radio value="1" label="&neverDNSSecure.label;"
+                    accesskey="&neverDNSSecure.accesskey;"/>
+             <radio value="0" label="&possibleDNSSecure.label;"
+                    accesskey="&possibleDNSSecure.accesskey;"/>
+           </radiogroup>
+          </groupbox>
+        </tabpanel>
+
       </tabpanels>
     </tabbox>
   </prefpane>
diff --git a/browser/locales/en-US/chrome/browser/preferences/advanced.dtd b/browser/locales/en-US/chrome/browser/preferences/advanced.dtd
index f3578b4..380db8b 100644
--- a/browser/locales/en-US/chrome/browser/preferences/advanced.dtd
+++ b/browser/locales/en-US/chrome/browser/preferences/advanced.dtd
@@ -115,3 +115,13 @@
 <!ENTITY verify2.accesskey               "V">
 <!ENTITY viewSecurityDevices.label       "Security Devices">
 <!ENTITY viewSecurityDevices.accesskey   "y">
+
+<!ENTITY dnssecTab.label                "DNS Security">
+<!ENTITY dnssec.description             "DNS Security Policy is currently set at the system level (e.g. /etc/dnsval.conf) and this option specifies if the configured DNS Security policy should be enforced.">
+<!ENTITY dnsSecurity.label              "DNS Security Policy">
+<!ENTITY neverDNSSecure.label           "Ignore DNS security">
+<!ENTITY neverDNSSecure.accesskey       "N">
+<!ENTITY possibleDNSSecure.label        "Enforce DNS Security System Policy">
+<!ENTITY possibleDNSSecure.accesskey    "E">
+<!ENTITY allDNSSecure.label             "Require all DNS lookups to be secure">
+<!ENTITY allDNSSecure.accesskey         "A">
diff --git a/layout/base/nsPresContext.cpp b/layout/base/nsPresContext.cpp
index bf3be06..bf5ec30 100644
--- a/layout/base/nsPresContext.cpp
+++ b/layout/base/nsPresContext.cpp
@@ -67,6 +67,8 @@
 #include "nsIWeakReferenceUtils.h"
 #include "nsCSSRendering.h"
 #include "prprf.h"
+#include "prnetdb.h"
+#include "nsContentPolicyUtils.h"
 #include "nsIDOMDocument.h"
 #include "nsAutoPtr.h"
 #include "nsEventStateManager.h"
@@ -311,6 +313,11 @@ nsPresContext::~nsPresContext()
   Preferences::UnregisterCallback(nsPresContext::PrefChangedCallback,
                                   "image.animation_mode",
                                   this);
+#ifdef MOZ_DNSSEC
+  Preferences::UnregisterCallback(nsPresContext::PrefChangedCallback,
+                                  "security.dnssec.dnssecBehavior",
+                                  this);
+#endif
 #ifdef IBMBIDI
   Preferences::UnregisterCallback(nsPresContext::PrefChangedCallback,
                                   "bidi.",
@@ -794,6 +801,10 @@ nsPresContext::GetUserPreferences()
   else // dynamic change to invalid value should act like it does initially
     mImageAnimationModePref = imgIContainer::kNormalAnimMode;
 
+#ifdef MOZ_DNSSEC
+  PR_set_dnssec_validate_policy(Preferences::GetInt("security.dnssec.dnssecBehavior"));
+#endif /* MOZ_DNSSEC */
+
   PRUint32 bidiOptions = GetBidi();
 
   PRInt32 prefInt =
@@ -1025,6 +1036,11 @@ nsPresContext::Init(nsDeviceContext* aDeviceContext)
   Preferences::RegisterCallback(nsPresContext::PrefChangedCallback,
                                 "image.animation_mode",
                                 this);
+#ifdef MOZ_DNSSEC
+  Preferences::RegisterCallback(nsPresContext::PrefChangedCallback,
+                                 "security.dnssec.dnssecBehavior",
+                                 this);
+#endif
 #ifdef IBMBIDI
   Preferences::RegisterCallback(nsPresContext::PrefChangedCallback,
                                 "bidi.",
-- 
1.7.7.6

